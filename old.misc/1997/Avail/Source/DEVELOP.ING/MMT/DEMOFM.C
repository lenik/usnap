/***********************************************************
 TITLE DEMOFM.C

 This program demostrates how to call the SBFM low level
 functions to play a 'C major scale' using each of the 10
 instruments defined.

 The program is responsible for the timing between notes.

 The program checks the BLASTER environment for the Card
 settings. It also performs a test based on the BLASTER
 environment settings to ensure they tally with the hardware
 settings on the Card.
 **********************************************************/

#include <io.h>
#include <dos.h>
#include <stdio.h>
#include <bios.h>
#include <fcntl.h>
#include <sbcmusic.h>
#include <sbc.h>

  char inst[128][16]={
    // instrument1
    { 0x021, 0x011, 0x04c, 0x000, 0x0f1, 0x0f2, 0x063, 0x072,
      0x000, 0x000, 0x004, 0x000, 0x000, 0x000, 0x000, 0x000},
    { 0x0a5, 0x0b1, 0x0d2, 0x080, 0x081, 0x0f1, 0x003, 0x005,
      0x000, 0x000, 0x002, 0x000, 0x000, 0x000, 0x000, 0x000},
    { 0x072, 0x062, 0x01c, 0x005, 0x051, 0x052, 0x003, 0x013,
      0x000, 0x000, 0x00e, 0x000, 0x000, 0x000, 0x000, 0x000},
    { 0x011, 0x001, 0x08a, 0x040, 0x0f1, 0x0f1, 0x011, 0x0b3,
      0x000, 0x000, 0x006, 0x000, 0x000, 0x000, 0x000, 0x000},
    { 0x021, 0x001, 0x011, 0x000, 0x0a3, 0x0c4, 0x043, 0x022,
      0x002, 0x000, 0x00d, 0x000, 0x000, 0x000, 0x000, 0x000},
    // instrument2
    { 0x031, 0x0a1, 0x01c, 0x080, 0x041, 0x092, 0x00b, 0x03b,
      0x000, 0x000, 0x00e, 0x000, 0x000, 0x000, 0x000, 0x000},
    { 0x071, 0x062, 0x0c5, 0x005, 0x06e, 0x08b, 0x017, 0x00e,
      0x000, 0x000, 0x002, 0x000, 0x000, 0x000, 0x000, 0x000},
    { 0x041, 0x091, 0x083, 0x000, 0x065, 0x032, 0x005, 0x074,
      0x000, 0x000, 0x00a, 0x000, 0x000, 0x000, 0x000, 0x000},
    { 0x032, 0x016, 0x087, 0x080, 0x0a1, 0x070, 0x010, 0x033,
      0x000, 0x000, 0x008, 0x000, 0x000, 0x000, 0x000, 0x000},
    { 0x001, 0x013, 0x08d, 0x000, 0x051, 0x052, 0x053, 0x07c,
      0x001, 0x000, 0x00c, 0x000, 0x000, 0x000, 0x000, 0x000}
  };

main(){
  if (!GetEnvSetting())
    if(sbc_check_card()&2){
      sbfd_init();
      sbfd_instrument((char far*)inst);
      PlayScale();
      sbfd_reset();
    }else
      printf("FM music not available or wrong I/O settings.\n ");
  else
    printf("BLASTER environment not set or incomplete or invalid.\n");
}

#pragma loop_opt(off)
PlayScale(void){
  unsigned i,j;
  int inst, note;
  static char note_num[]={60, 62, 64, 65, 67, 69, 71, 72};
  for (inst=0; inst<10; inst++){
    sbfd_program_change(0, (char)inst);
    for (note=0; note<8; note++){
      sbfd_note_on(0, note_num[note], 0x40);
      for (i=0; i<100; i++)
	for (j=0; j<1000; j++);
      sbfd_note_off(0, note_num[note], 0x40);
    }
  }
}
#pragma loop_opt()
